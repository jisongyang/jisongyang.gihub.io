<!DOCTYPE html>
<html>
<head>
<title>qq_wechat_records.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<meta name="viewport" content="width=device-width, initial-scale=1.0" charset="utf-8">
<div id="navifation" class='headbar'>
    <iframe id='head' align="center" width="100%" height="160" src=""  frameborder="no" border="0" marginwidth="0" marginheight="px" scrolling="no" ></iframe>
</div>
<style>
    .headbar{text-align:center;background-color:white}
    .iframe{margin:0 auto;}
</style>
<script>
    var oDiv = document.getElementById('head');
    oDiv.style.position = 'fixed'; oDiv.style.top = '0px'; oDiv.style.left = '0px';
    document.title="导出QQ聊天记录和微信聊天记录";
</script>
<br><br>
<h1 id="%E5%AF%BC%E5%87%BAqq%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95%E5%92%8C%E5%BE%AE%E4%BF%A1%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">导出QQ聊天记录和微信聊天记录</h1>
<p><font color=red>【ps：本方法只提取文本消息，不含图片、视频、表情、连接】</font></p>
<!-- [设备环境](###设备环境) -->
<!-- [toc] -->
<ul>
<li><a href="#%E5%AF%BC%E5%87%BAqq%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95%E5%92%8C%E5%BE%AE%E4%BF%A1%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">导出QQ聊天记录和微信聊天记录</a>
<ul>
<li><a href="#1%E7%8E%AF%E5%A2%83">1.环境</a></li>
<li><a href="#2%E6%80%BB%E4%BD%93%E6%B5%81%E7%A8%8B">2.总体流程</a></li>
<li><a href="#3%E5%AF%BC%E5%87%BAqq%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">3.导出QQ聊天记录</a>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%AE%89%E8%A3%85vmos">第一步：安装VMOS</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E5%AE%89%E8%A3%8532%E4%BD%8Dqq">第二步：安装32位QQ</a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">第三步：备份和恢复聊天记录</a></li>
<li><a href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%E5%9C%A8vmos%E4%B8%AD%E5%A4%87%E4%BB%BDqq">第四步：在VMOS中备份QQ</a></li>
<li><a href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%E6%89%BE%E5%88%B0%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95%E6%95%B0%E6%8D%AE%E5%BA%93qq%E5%8F%B7db">第五步：找到聊天记录数据库（QQ号.db）</a></li>
<li><a href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%E8%A7%A3%E6%9E%90%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">第六步：解析聊天记录</a></li>
</ul>
</li>
<li><a href="#4%E5%AF%BC%E5%87%BA%E5%BE%AE%E4%BF%A1%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">4.导出微信聊天记录</a>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%AE%89%E8%A3%85vmos-1">第一步：安装VMOS</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E5%AE%89%E8%A3%8532%E4%BD%8D%E5%BE%AE%E4%BF%A1">第二步：安装32位微信</a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95-1">第三步：备份和恢复聊天记录</a></li>
<li><a href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%E5%9C%A8vmos%E4%B8%AD%E5%A4%87%E4%BB%BD%E5%BE%AE%E4%BF%A1">第四步：在VMOS中备份微信</a></li>
<li><a href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%E6%89%BE%E5%88%B0%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95%E6%95%B0%E6%8D%AE%E5%BA%93enmicromsgdb">第五步：找到聊天记录数据库（EnMicroMsg.db）</a></li>
<li><a href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%E8%A7%A3%E6%9E%90%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95-1">第六步：解析聊天记录</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="1%E7%8E%AF%E5%A2%83">1.环境</h3>
<ul>
<li>
<p>华为手机 + 鸿蒙2.0.0 + Windows</p>
</li>
<li>
<p>解析聊天记录文本需要 Python 和 sqlcipher</p>
</li>
</ul>
<h3 id="2%E6%80%BB%E4%BD%93%E6%B5%81%E7%A8%8B">2.总体流程</h3>
<ul>
<li>
<p>QQ微信聊天记录可以直接从手机备份到电脑，但是备份出来的文件无法查看内容。</p>
</li>
<li>
<p>同时，手机中的聊天记录保存的文件一般情况下是无法找到的。如果不root手机的话，可以使用【备份整个APP】的方法可以帮助导出聊天记录保存文件。</p>
</li>
<li>
<p>但是由于现在华为自带的备份软件的备份APP时候需要加密，导出也无法查看，所以借用了安卓虚拟系统VMOS来备份整个APP。</p>
</li>
<li>
<p>VMOS可以理解为，在手机中单独分一块空间出来当成一个虚拟新手机，这个新手机自带有一个备份功能，备份时候无需加密。</p>
</li>
<li>
<p>安装好VMOS后，需要在VMOS中再安装QQ或微信，但是这个虚拟新手机中的QQ或微信没有任何聊天记录。</p>
</li>
<li>
<p>因此，需要事先将手机中的聊天记录备份到电脑，再从电脑恢复到虚拟新手机中，此时再在虚拟新手机中【备份整个APP】就行了</p>
</li>
</ul>
<img src='record_work_flow.PNG'>
<h3 id="3%E5%AF%BC%E5%87%BAqq%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">3.导出QQ聊天记录</h3>
<h5 id="%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%AE%89%E8%A3%85vmos">第一步：安装VMOS</h5>
<ul>
<li>
<p>VMOS官网：<a href="http://www.vmos.cn/">http://www.vmos.cn/</a>，下载到手机上，安装</p>
</li>
<li>
<p>【不使用VMOS Pro是因为它没有备份APP的功能】</p>
</li>
</ul>
<h5 id="%E7%AC%AC%E4%BA%8C%E6%AD%A5%E5%AE%89%E8%A3%8532%E4%BD%8Dqq">第二步：安装32位QQ</h5>
<ul>
<li>VMOS中只支持32位的APP</li>
<li>QQ：<a href="https://im.qq.com/mobileqq">https://im.qq.com/mobileqq</a>，扫描下载32位版本</li>
<li>下载安装包之后，注意一下后缀名是不是.apk，如果多了字符（比如.apk.1），删掉多余的字符</li>
<li>打开VMOS，再打开（文件中转站），点击（我要导入），找到刚刚下载的安装包，导入会自动安装</li>
<li>【安装可能有点慢，安装完之后可能等一等才会显示安装成功】</li>
</ul>
<h5 id="%E7%AC%AC%E4%B8%89%E6%AD%A5%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">第三步：备份和恢复聊天记录</h5>
<ul>
<li>手机和电脑都登录QQ，在同一个wifi下，备份手机聊天记录到电脑，可以选指定的会话【挺快】</li>
<li>在VMOS中登录QQ，在同一个wifi下，恢复电脑聊天记录到手机，也可以选指定的会话【慢得要死】</li>
</ul>
<h5 id="%E7%AC%AC%E5%9B%9B%E6%AD%A5%E5%9C%A8vmos%E4%B8%AD%E5%A4%87%E4%BB%BDqq">第四步：在VMOS中备份QQ</h5>
<ul>
<li>打开VMOS中的（备份与恢复），点击(新建备份)，选中（应用程序）中的（QQ）,开始备份</li>
<li>备份整个APP的结果存在（<code>内部储存/VMOSfiletransferstation/Vmos_Backups</code>）下面，QQ的备份一般叫（com.tencent.mobileqq.tar.gz）</li>
<li>【需要手机有足够的内存，如果备份的时候卡了二十分钟没有进度，直接后台清除VMOS重新来】</li>
</ul>
<h5 id="%E7%AC%AC%E4%BA%94%E6%AD%A5%E6%89%BE%E5%88%B0%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95%E6%95%B0%E6%8D%AE%E5%BA%93qq%E5%8F%B7db">第五步：找到聊天记录数据库（QQ号.db）</h5>
<ul>
<li>将备份整个APP的结果（com.tencent.mobileqq.tar.gz）拷到电脑上，解压</li>
<li>在(<code>com.tencent.mobileqq.tar\com.tencent.mobileqq\databases</code>)文件夹下找到一个（你的QQ号.db）文件</li>
<li>【一般来说，上述文件夹有三个文件存有聊天记录，(QQ号-IndexQQMsg.db)和(QQ号.db)存有近21天记录，(slowtable_QQ号.db)存有21天之前的记录。】</li>
<li>【但是可能是由于此方法是在新装的QQ上导入聊天记录，所以所有的聊天记录都在（你的QQ号.db）文件中】</li>
</ul>
<h5 id="%E7%AC%AC%E5%85%AD%E6%AD%A5%E8%A7%A3%E6%9E%90%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">第六步：解析聊天记录</h5>
<ul>
<li>找到密钥
在用记事本打开(<code>com.tencent.mobileqq.tar\com.tencent.mobileqq\files\kc</code>)，可以看到字符串（比如12:34:56:2a:6b:cd），就是密钥</li>
<li>使用python解析聊天记录，需要在最下方配置参数，<font color=red>用于提取某一个特定会话的聊天记录</font>
【这里提取的记录以文本信息保存，但是含有表情、图片、连接的源码或引用源码，所有下一步可以考虑清洗数据】<pre class="hljs"><code><div><span class="hljs-keyword">from</span> _overlapped <span class="hljs-keyword">import</span> NULL
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">import</span> sqlite3
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">import</span> os


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QQoutput</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, db, key, mode)</span>:</span>
        self.key = key  <span class="hljs-comment">#解密用的密钥</span>
        self.c = sqlite3.connect(db).cursor()
        self.mode = mode
        <span class="hljs-comment"># self.s = s</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fix</span><span class="hljs-params">(self, data, mode)</span>:</span>
        <span class="hljs-comment">#msgdata mode=0</span>
        <span class="hljs-comment">#other mode=1</span>
        <span class="hljs-keyword">if</span> (mode == <span class="hljs-number">0</span>):
            rowbyte = []
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(data)):
                rowbyte.append(data[i] ^ ord(self.key[i % len(self.key)]))
            rowbyte = bytes(rowbyte)
            <span class="hljs-keyword">try</span>:
                msg = rowbyte.decode(encoding=<span class="hljs-string">"utf-8"</span>)
            <span class="hljs-keyword">except</span>:
                msg = NULL
            <span class="hljs-keyword">return</span> msg
        <span class="hljs-keyword">elif</span> (mode == <span class="hljs-number">1</span>):
            str = <span class="hljs-string">""</span>
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(data)):
                    str += chr(ord(data[i]) ^ ord(self.key[i % len(self.key)]))
            <span class="hljs-keyword">except</span>:
                str = NULL
            <span class="hljs-keyword">return</span> str

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode</span><span class="hljs-params">(self, cursor)</span>:</span>
        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
            <span class="hljs-keyword">continue</span>
        data = row[<span class="hljs-number">0</span>]
        MsgEnc = self.s.encode(encoding=<span class="hljs-string">"utf-8"</span>)
        KeySet = <span class="hljs-string">""</span>
        <span class="hljs-comment">#for i in range(0,min(len(MsgEnc), len(data))):</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(MsgEnc)):
            KeySet += chr(data[i] ^ MsgEnc[i])
        <span class="hljs-comment">#TO AVOID LOOP</span>
        RealKey, restKey = <span class="hljs-string">""</span>, <span class="hljs-string">""</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>, len(KeySet)):
            <span class="hljs-string">'''
            bug WARNING!!
            Assuming Key should be longer than 5 digits
            To Prevent string loop in single key
            Like "121212456"
            '''</span>
            RealKey, nextKey, restKey = KeySet[<span class="hljs-number">0</span>:i], KeySet[i:<span class="hljs-number">2</span> * i], KeySet[
                <span class="hljs-number">2</span> * i:len(KeySet)]
            KeyLen = len(RealKey)
            flagLoop = <span class="hljs-literal">True</span>
            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(KeyLen):
                <span class="hljs-keyword">if</span> ((j &lt; len(nextKey) <span class="hljs-keyword">and</span> RealKey[j] != nextKey[j])
                        <span class="hljs-keyword">or</span> (j &lt; len(restKey) <span class="hljs-keyword">and</span> RealKey[j] != restKey[j])):
                    flagLoop = <span class="hljs-literal">False</span>
                    <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">if</span> (flagLoop <span class="hljs-keyword">and</span> j == KeyLen - <span class="hljs-number">1</span>):
                <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">return</span> RealKey

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">AddEmoji</span><span class="hljs-params">(self, msg)</span>:</span>
        pos = msg.find(<span class="hljs-string">'\x14'</span>)
        <span class="hljs-keyword">while</span> (pos != <span class="hljs-number">-1</span>):
            lastpos = pos
            num = ord(msg[pos + <span class="hljs-number">1</span>])
            msg = msg.replace(
                msg[pos:pos + <span class="hljs-number">2</span>],
                <span class="hljs-string">"&lt;img src='./gif/"</span> + str(num) + <span class="hljs-string">".gif' alt="</span> + str(num) + <span class="hljs-string">"&gt;"</span>)
            pos = msg.find(<span class="hljs-string">'\x14'</span>)
            <span class="hljs-keyword">if</span> (pos == lastpos):
                <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">return</span> msg

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">message</span><span class="hljs-params">(self, num_in, mode)</span>:</span>
        <span class="hljs-comment">#mode=1 friend</span>
        <span class="hljs-comment">#mode=2 troop</span>
        num = str(num_in).encode(<span class="hljs-string">"utf-8"</span>)
        md5num = hashlib.md5(num).hexdigest().upper()
        <span class="hljs-keyword">if</span> (mode == <span class="hljs-number">1</span>):
            execute = <span class="hljs-string">"select msgData,senderuin,time from mr_friend_{md5num}_New"</span>.format(
                md5num=md5num)
        <span class="hljs-keyword">elif</span> (mode == <span class="hljs-number">2</span>):
            execute = <span class="hljs-string">"select msgData,senderuin,time from mr_troop_{md5num}_New"</span>.format(
                md5num=md5num)
        <span class="hljs-keyword">else</span>:
            print(<span class="hljs-string">"error mode"</span>)
            exit(<span class="hljs-number">1</span>)
        <span class="hljs-comment">#try:</span>
        cursor = self.c.execute(execute)
        <span class="hljs-comment">#except:</span>
        <span class="hljs-comment">#    raise ValueError("QQ号/db地址错误")</span>
        <span class="hljs-keyword">if</span> (self.key == <span class="hljs-string">""</span> <span class="hljs-keyword">and</span> len(self.s) &gt;= <span class="hljs-number">5</span>):
            self.key = self.decode(cursor)
        cursor = self.c.execute(execute)
        allmsg = []
        count=<span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
            msgdata = row[<span class="hljs-number">0</span>]
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> msgdata):
                <span class="hljs-keyword">continue</span>
            uin = row[<span class="hljs-number">1</span>]
            ltime = time.localtime(row[<span class="hljs-number">2</span>])

            sendtime = time.strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>, ltime)
            msg = self.fix(msgdata, <span class="hljs-number">0</span>)
            senderuin = self.fix(uin, <span class="hljs-number">1</span>)
            <span class="hljs-comment"># print(num_in)</span>
            isSend=<span class="hljs-string">'0'</span> <span class="hljs-keyword">if</span> senderuin==num_in <span class="hljs-keyword">else</span> <span class="hljs-string">'1'</span>
            amsg = []
            amsg.append(sendtime)
            <span class="hljs-comment"># amsg.append(senderuin)</span>
            amsg.append(isSend)
            amsg.append(str(msg))
            allmsg.append(amsg)
        <span class="hljs-keyword">return</span> allmsg

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">(db, qq, key,now_name)</span>:</span>
    mode = <span class="hljs-number">1</span>

    q = QQoutput(db, key, mode)
    allmsg = q.message(qq, mode)
    print(<span class="hljs-string">'allmsg num:'</span>,len(allmsg))

    os.makedirs(now_name,exist_ok=<span class="hljs-literal">True</span>)
    save_file=os.path.join(now_name,now_name+<span class="hljs-string">'_origin.txt'</span>)
    <span class="hljs-keyword">with</span> open(save_file,<span class="hljs-string">'w'</span>,encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> allmsg:
            f.write(str(msg)+<span class="hljs-string">'\n'</span>)


<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">'__main__'</span>:
    db = <span class="hljs-string">"QQ号.db"</span>                  <span class="hljs-comment"># 文件位置</span>
    key=<span class="hljs-string">''</span>                          <span class="hljs-comment"># 密钥</span>
    qq = <span class="hljs-string">""</span>                         <span class="hljs-comment"># 指定某一个会话的QQ号（比如某一个好友的QQ号）</span>
    now_name=<span class="hljs-string">''</span>                     <span class="hljs-comment"># 最后保存聊天记录文件的名字（比如好友的名字）</span>
    main(db, qq, key, now_name)
</div></code></pre>
</li>
<li>清洗聊天记录，只保留文本信息<pre class="hljs"><code><div><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> re

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">textclean</span><span class="hljs-params">(now_name)</span>:</span>
    count=<span class="hljs-number">0</span>
    file=os.path.join(now_name,now_name+<span class="hljs-string">'_origin.txt'</span>)
    newfile=os.path.join(now_name,now_name+<span class="hljs-string">'_clean.txt'</span>)
    <span class="hljs-keyword">with</span> open(newfile,<span class="hljs-string">'w'</span>,encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> w:
        <span class="hljs-keyword">with</span> open(file,<span class="hljs-string">'r'</span>,encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
            <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> f.readlines():
                [sendtime,isSend,content] = eval(data)
                <span class="hljs-comment"># print(content)</span>

                <span class="hljs-keyword">if</span>(content==<span class="hljs-string">'0'</span>):
                    <span class="hljs-keyword">continue</span>

                <span class="hljs-keyword">if</span>(<span class="hljs-string">'QQfile_recv'</span> <span class="hljs-keyword">in</span> content <span class="hljs-keyword">or</span> <span class="hljs-string">'http'</span> <span class="hljs-keyword">in</span> content <span class="hljs-keyword">or</span> <span class="hljs-string">'bgColor'</span> <span class="hljs-keyword">in</span> content
                <span class="hljs-keyword">or</span> <span class="hljs-string">'plaintext'</span> <span class="hljs-keyword">in</span> content <span class="hljs-keyword">or</span> <span class="hljs-string">'ed2k:'</span> <span class="hljs-keyword">in</span> content <span class="hljs-keyword">or</span> <span class="hljs-string">'.exe'</span> <span class="hljs-keyword">in</span> content <span class="hljs-keyword">or</span>
                <span class="hljs-string">'.xls'</span> <span class="hljs-keyword">in</span> content <span class="hljs-keyword">or</span> <span class="hljs-string">'.docx'</span> <span class="hljs-keyword">in</span> content <span class="hljs-keyword">or</span> <span class="hljs-string">'.ppt'</span> <span class="hljs-keyword">in</span> content <span class="hljs-keyword">or</span> <span class="hljs-string">'*****'</span> <span class="hljs-keyword">in</span> content
                <span class="hljs-keyword">or</span> <span class="hljs-string">'撤回了一条消息'</span> <span class="hljs-keyword">in</span> content):
                    <span class="hljs-keyword">continue</span>

                content=replace_emoji(content)
                <span class="hljs-keyword">if</span>(content==<span class="hljs-string">''</span>):
                    <span class="hljs-keyword">continue</span>

                <span class="hljs-comment"># print(content)</span>
                w.write(str([sendtime,isSend,content])+<span class="hljs-string">'\n'</span>)
                count+=<span class="hljs-number">1</span>

    print(count)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">replace_emoji</span><span class="hljs-params">(my_str)</span>:</span>
    rep = {<span class="hljs-string">"\x14\x8d"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"\x14¨"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14®"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x97"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x8f"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14³"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14O"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14ª"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\n"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14Ñ"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14»"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14 "</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x0f"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x144"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14©"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x17"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14X"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14«"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14¡"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x140"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14\x11"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14F"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14c"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14S"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14¬"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14R"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\t"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14¦"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x15"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x95"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x93"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14)"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x99"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14\x98"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x1c"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14#"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14¯"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14G"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14@"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14\x01"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14N"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14đ"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14Ć"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x16"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14ċ"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x92"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x145"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14ą"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14U"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14'"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14Ì"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x1e"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x03101\x12\x00\x1a\x00"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\xa0"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14½"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14¹"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14¥"</span>:<span class="hljs-string">""</span>,<span class="hljs-string">'\x14ć'</span>:<span class="hljs-string">""</span>,<span class="hljs-string">"\x14Ø"</span>:<span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14ġ"</span>:<span class="hljs-string">""</span>,<span class="hljs-string">'\x14Ń'</span>:<span class="hljs-string">''</span>,<span class="hljs-string">"\x14Ċ"</span>:<span class="hljs-string">''</span>,<span class="hljs-string">'\x14ĉ'</span>:<span class="hljs-string">""</span>,<span class="hljs-string">"\x14Ĉ"</span>:<span class="hljs-string">''</span>,<span class="hljs-string">'\x14a'</span>:<span class="hljs-string">''</span>,
        <span class="hljs-string">"\x011\x12\x0216\x18\x05 \x01(\x012\x00:\x07/流泪B\x00H\x01\x00\x00"</span>:<span class="hljs-string">''</span>,}
    rep = dict((re.escape(k), v) <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> rep.items())
    pattern = re.compile(<span class="hljs-string">"|"</span>.join(rep.keys()))
    my_str = pattern.sub(<span class="hljs-keyword">lambda</span> m: rep[re.escape(m.group(<span class="hljs-number">0</span>))], my_str)
    <span class="hljs-keyword">return</span> my_str



<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">'__main__'</span>:
    now_name=<span class="hljs-string">''</span>                  <span class="hljs-comment"># 上一步设置的最后保存聊天记录文件的名字（比如好友的名字）</span>
    textclean(now_name)
</div></code></pre>
</li>
</ul>
<h3 id="4%E5%AF%BC%E5%87%BA%E5%BE%AE%E4%BF%A1%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">4.导出微信聊天记录</h3>
<h5 id="%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%AE%89%E8%A3%85vmos">第一步：安装VMOS</h5>
<ul>
<li>同上</li>
</ul>
<h5 id="%E7%AC%AC%E4%BA%8C%E6%AD%A5%E5%AE%89%E8%A3%8532%E4%BD%8D%E5%BE%AE%E4%BF%A1">第二步：安装32位微信</h5>
<ul>
<li>同上</li>
<li>微信：<a href="https://weixin.qq.com/">https://weixin.qq.com/</a>，点击（微信 x.x.x Android正式版发布）,然后下载32位版本</li>
</ul>
<h5 id="%E7%AC%AC%E4%B8%89%E6%AD%A5%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">第三步：备份和恢复聊天记录</h5>
<ul>
<li>同上</li>
<li>【指定少数人之后，微信的备份和恢复还是比较快的】</li>
</ul>
<h5 id="%E7%AC%AC%E5%9B%9B%E6%AD%A5%E5%9C%A8vmos%E4%B8%AD%E5%A4%87%E4%BB%BD%E5%BE%AE%E4%BF%A1">第四步：在VMOS中备份微信</h5>
<ul>
<li>同上</li>
<li>微信的备份一般叫（com.tencent.mm.tar.gz）</li>
</ul>
<h5 id="%E7%AC%AC%E4%BA%94%E6%AD%A5%E6%89%BE%E5%88%B0%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95%E6%95%B0%E6%8D%AE%E5%BA%93enmicromsgdb">第五步：找到聊天记录数据库（EnMicroMsg.db）</h5>
<ul>
<li>将备份整个APP的结果（com.tencent.mm.tar.gz）拷到电脑上，解压</li>
<li>在(<code>com.tencent.mm.tar\com.tencent.mm\MicroMsg</code>)`文件夹下，找到名字是16进制字符且比较长的文件夹（类似于47e2b5ca90cda7d8a508e11a6fecfa26）</li>
<li>这样的文件夹可能会有多个，其实是对应手机曾经登录的多个微信。但是每一个文件夹里面都会含有（EnMicroMsg.db）文件</li>
<li>找到最大的（EnMicroMsg.db）文件，毕竟自己的微信聊天记录肯定是最多的，除非想提取微信小号的聊天记录，那就一个一个尝试。
【白痴问题：一开始没找到（EnMicroMsg.db）文件，搜索了好久，结果发现是自己解压的时候中断了，没有完全解压出来】</li>
</ul>
<h5 id="%E7%AC%AC%E5%85%AD%E6%AD%A5%E8%A7%A3%E6%9E%90%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95">第六步：解析聊天记录</h5>
<ul>
<li>
<p>找到uin值
记事本打开（<code>com.tencent.mm.tar\com.tencent.mm\shared_prefs\auth_info_key_prefs.xml</code>）, 找到类似于<code>&lt;int name=&quot;_auth_uin&quot; value=&quot;-2069473988&quot; /&gt;</code>，这里的value后面的值就是uin值，正负数都有可能</p>
</li>
<li>
<p>找到密钥
不同微信版本密钥可能不一样，之前的说法有（IMEI值和uin值拼接形成字符串）的32位小写MD5加密的前七位，上一次提取记录确实就是这样的密钥。
但是时间推移，本次的密钥实际是（1234567890ABCDEF和uin值拼接）的32位小写MD5加密的前七位。
即，(1234567890ABCDEF-2069473988)经过32位MD5加密后小写的前七位。</p>
</li>
<li>
<p>打开数据库
下载sqlcipher <a href="https://pan.cstcloud.cn/s/xekJrl6DTI">https://pan.cstcloud.cn/s/xekJrl6DTI</a>，也可以自行网上搜索下载。然后将（EnMicroMsg.db）文件拖入，输入密钥打开</p>
</li>
<li>
<p>导出CSV
依次点击(File-Export-Table as CSV file)，选择Table name为（message），一般下拉菜单在最下边，导出</p>
</li>
<li>
<p>使用python解析聊天记录，需要在最下方配置参数，<font color=red>用于提取某一个特定会话的聊天记录</font>
【这里提取的记录以文本信息保存，但是含有表情、图片、连接的源码或引用源码，所有下一步可以考虑清洗数据】</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> os
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">csv2txt</span><span class="hljs-params">(file,result,now_id,now_name)</span>:</span>
    <span class="hljs-keyword">with</span> open(file,<span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
        start_count=<span class="hljs-number">0</span>
        count=<span class="hljs-number">0</span>
        start=<span class="hljs-number">0</span>
        max=<span class="hljs-number">200</span>
        <span class="hljs-comment"># now_id='"wxid_h1hq379r4ea322"'</span>
        now_messge=[]
        messge_time=[]
        messge_dict={}
        <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> f.readlines():
            start_count+=<span class="hljs-number">1</span>
            <span class="hljs-keyword">if</span>(start_count&gt;start):
                <span class="hljs-comment"># print(data)</span>
                lis = data.decode(<span class="hljs-string">'gb18030'</span>,<span class="hljs-string">'ignore'</span>).split(<span class="hljs-string">','</span>)
                <span class="hljs-comment"># print(lis)</span>
                <span class="hljs-keyword">try</span>:
                    [msgid,isSend,createTime,talker,content]=[lis[<span class="hljs-number">0</span>],lis[<span class="hljs-number">4</span>],lis[<span class="hljs-number">6</span>],lis[<span class="hljs-number">7</span>],lis[<span class="hljs-number">8</span>]]
                    <span class="hljs-keyword">if</span> ((<span class="hljs-string">'wxid'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> talker) <span class="hljs-keyword">or</span> (<span class="hljs-string">'wxid'</span> <span class="hljs-keyword">in</span> content) <span class="hljs-keyword">or</span> (<span class="hljs-string">'?xml'</span> <span class="hljs-keyword">in</span> content)):
                        <span class="hljs-keyword">continue</span>
                    <span class="hljs-comment"># print([msgid,isSend,createTime,talker,content])</span>
                    <span class="hljs-keyword">if</span>(talker==now_id):
                        now_messge.append([msgid,isSend,createTime,content])
                        messge_dict[str(createTime)]=[msgid,isSend,createTime,content]
                        messge_time.append(createTime)
                        count += <span class="hljs-number">1</span>
                <span class="hljs-keyword">except</span>:
                    <span class="hljs-keyword">pass</span>

                <span class="hljs-keyword">if</span>(start_count%<span class="hljs-number">200000</span>==<span class="hljs-number">0</span>):
                    print(<span class="hljs-string">'swap lines:'</span>,start_count)

            <span class="hljs-comment"># if(count&gt;max):</span>
            <span class="hljs-comment">#     break</span>
    print(len(now_messge))

    messge_time.sort()
    save_file=os.path.join(result,now_name,now_name+<span class="hljs-string">'_origin.txt'</span>)
    <span class="hljs-keyword">with</span> open(save_file,<span class="hljs-string">'w'</span>,encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> w:
        <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> messge_time:
        <span class="hljs-comment"># for data in now_messge:</span>
            data=messge_dict[str(key)]
            w.write(str(data)+<span class="hljs-string">'\n'</span>)

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">'__main__'</span>:
    file=<span class="hljs-string">".csv"</span>                             <span class="hljs-comment"># CSV文件位置</span>
    now_id=<span class="hljs-string">'"wxid_xu9z2jm5x1l622"'</span>          <span class="hljs-comment"># 某个会话的id，实际就好友的微信号，在手机可以看，注意需要有双引号</span>
    result=<span class="hljs-string">''</span>                               <span class="hljs-comment"># 保存聊天记录的文件夹</span>
    os.makedirs(result,exist_ok=<span class="hljs-literal">True</span>)
    now_name=<span class="hljs-string">''</span>                             <span class="hljs-comment"># 保存聊天记录的文件（比如当前好友的名字）</span>
    os.makedirs(os.path.join(result,now_name), exist_ok=<span class="hljs-literal">True</span>)
    csv2txt(file,result,now_id,now_name)
</div></code></pre>
</li>
<li>
<p>清洗聊天记录，只保留文本信息</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> re
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">textclean</span><span class="hljs-params">(file,newfile,now_name,)</span>:</span>
    count=<span class="hljs-number">0</span>
    <span class="hljs-keyword">with</span> open(newfile,<span class="hljs-string">'w'</span>,encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> w:
        <span class="hljs-keyword">with</span> open(file,<span class="hljs-string">'r'</span>,encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
            <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> f.readlines():
                [msgid,issend,sendtime,content]=eval(data)
                <span class="hljs-comment"># print([msgid,issend,sendtime,content])</span>
                issend = issend[<span class="hljs-number">1</span>:<span class="hljs-number">-1</span>]
                time_local = time.localtime(int(sendtime[<span class="hljs-number">1</span>:<span class="hljs-number">-1</span>])/<span class="hljs-number">1000</span>)
                dt = time.strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>, time_local)
                <span class="hljs-comment"># print(dt)</span>
                content=content[<span class="hljs-number">1</span>:<span class="hljs-number">-1</span>]
                <span class="hljs-keyword">if</span>((<span class="hljs-string">'撤回了一条消息'</span> <span class="hljs-keyword">in</span> content) <span class="hljs-keyword">or</span> (<span class="hljs-string">'&lt;msg&gt;'</span> <span class="hljs-keyword">in</span> content) <span class="hljs-keyword">or</span> (<span class="hljs-string">'&lt;img src='</span> <span class="hljs-keyword">in</span> content) <span class="hljs-keyword">or</span> (<span class="hljs-string">'http'</span> <span class="hljs-keyword">in</span> content) <span class="hljs-keyword">or</span> (<span class="hljs-string">'??【'</span>) <span class="hljs-keyword">in</span> content):
                    <span class="hljs-keyword">continue</span>

                content=replace_emoji(content)
                <span class="hljs-keyword">if</span>(content==<span class="hljs-string">''</span>):
                    <span class="hljs-keyword">continue</span>

                w.write(str([dt,issend,content])+<span class="hljs-string">'\n'</span>)
                count+=<span class="hljs-number">1</span>
    print(count)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">replace_emoji</span><span class="hljs-params">(my_str)</span>:</span>
    rep = {<span class="hljs-string">"\x14\x8d"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"\x14¨"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14®"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x97"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x8f"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14³"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14O"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14ª"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\n"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14Ñ"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14»"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14 "</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x0f"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x144"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14©"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x17"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14X"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14«"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14¡"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x140"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14\x11"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14F"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14c"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14S"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14¬"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14R"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\t"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14¦"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x15"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x95"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x93"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14)"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x99"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14\x98"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x1c"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14#"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14¯"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14G"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14@"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14\x01"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14N"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14đ"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14Ć"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x16"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14ċ"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x92"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x145"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14ą"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14U"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14'"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14Ì"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14\x1e"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"\x03101\x12\x00\x1a\x00"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\xa0"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14½"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14¹"</span>: <span class="hljs-string">""</span>,<span class="hljs-string">"\x14¥"</span>:<span class="hljs-string">""</span>,<span class="hljs-string">'\x14ć'</span>:<span class="hljs-string">""</span>,<span class="hljs-string">"\x14Ø"</span>:<span class="hljs-string">""</span>,
        <span class="hljs-string">"\x14ġ"</span>:<span class="hljs-string">""</span>,<span class="hljs-string">'\x14Ń'</span>:<span class="hljs-string">''</span>,<span class="hljs-string">"\x14Ċ"</span>:<span class="hljs-string">''</span>,<span class="hljs-string">'\x14ĉ'</span>:<span class="hljs-string">""</span>,<span class="hljs-string">"\x14Ĉ"</span>:<span class="hljs-string">''</span>,<span class="hljs-string">'\x14a'</span>:<span class="hljs-string">''</span>,<span class="hljs-string">"\ue412"</span>:<span class="hljs-string">''</span>,<span class="hljs-string">'\ue40d'</span>:<span class="hljs-string">''</span>,
        <span class="hljs-string">"\x011\x12\x0216\x18\x05 \x01(\x012\x00:\x07/流泪B\x00H\x01\x00\x00"</span>:<span class="hljs-string">''</span>,
        <span class="hljs-string">'\ue40e'</span>:<span class="hljs-string">''</span>,<span class="hljs-string">'\ue403'</span>:<span class="hljs-string">''</span>}
    rep = dict((re.escape(k), v) <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> rep.items())
    pattern = re.compile(<span class="hljs-string">"|"</span>.join(rep.keys()))
    my_str = pattern.sub(<span class="hljs-keyword">lambda</span> m: rep[re.escape(m.group(<span class="hljs-number">0</span>))], my_str)
    <span class="hljs-keyword">return</span> my_str

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">'__main__'</span>:

    result=<span class="hljs-string">''</span>                                       <span class="hljs-comment"># 上一步设置的，保存聊天记录的文件夹</span>
    <span class="hljs-comment"># os.makedirs(result,exist_ok=True)</span>
    now_name=<span class="hljs-string">''</span>                                     <span class="hljs-comment"># 上一步设置的，保存聊天记录的文件（比如当前好友的名字）</span>
    <span class="hljs-comment"># os.makedirs(os.path.join(result,now_name), exist_ok=True)</span>
    file = os.path.join(result, now_name, now_name + <span class="hljs-string">'_origin.txt'</span>)
    <span class="hljs-comment"># now_name='luoran'</span>
    newfile = os.path.join(result,now_name, now_name + <span class="hljs-string">'_clean.txt'</span>)

    textclean(file,newfile,now_name)
</div></code></pre>
</li>
</ul>

</body>
</html>
